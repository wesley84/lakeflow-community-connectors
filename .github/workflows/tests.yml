name: Tests

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  # Detect which paths changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      libs: ${{ steps.check.outputs.libs }}
      pipeline: ${{ steps.check.outputs.pipeline }}
      example: ${{ steps.check.outputs.example }}
      community_connector: ${{ steps.check.outputs.community_connector }}
    steps:
      - uses: actions/checkout@v4
      # cannot use dorny because of ip allowlisting
      # - uses: dorny/paths-filter@v3
        with:
          fetch-depth: 0
      - name: Check changed paths
        id: check
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.event.after }}"
          fi

          # Handle initial commit or force push
          if ! git cat-file -e "$BASE_SHA" 2>/dev/null; then
            BASE_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "")
          fi

          if [ -z "$BASE_SHA" ]; then
            # First commit, check all files
            CHANGED_FILES=$(git ls-files)
          else
            CHANGED_FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA")
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check libs
          if echo "$CHANGED_FILES" | grep -q '^libs/'; then
            echo "libs=true" >> $GITHUB_OUTPUT
          else
            echo "libs=false" >> $GITHUB_OUTPUT
          fi

          # Check pipeline
          if echo "$CHANGED_FILES" | grep -q '^pipeline/'; then
            echo "pipeline=true" >> $GITHUB_OUTPUT
          else
            echo "pipeline=false" >> $GITHUB_OUTPUT
          fi

          # Check example (also triggers on interface changes)
          if echo "$CHANGED_FILES" | grep -qE '^sources/(example|interface)/'; then
            echo "example=true" >> $GITHUB_OUTPUT
          else
            echo "example=false" >> $GITHUB_OUTPUT
          fi

          # Check tools/community_connector
          if echo "$CHANGED_FILES" | grep -q '^tools/community_connector/'; then
            echo "community_connector=true" >> $GITHUB_OUTPUT
          else
            echo "community_connector=false" >> $GITHUB_OUTPUT
          fi

  # Test libs
  test-libs:
    needs: changes
    if: ${{ needs.changes.outputs.libs == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Run libs tests
        run: |
          pytest libs/test/ -v

  # Test pipeline
  test-pipeline:
    needs: changes
    if: ${{ needs.changes.outputs.pipeline == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Run pipeline tests
        run: |
          pytest pipeline/test/ -v

  # Test example source
  test-example:
    needs: changes
    if: ${{ needs.changes.outputs.example == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Run example tests
        run: |
          pytest sources/example/test/ -v

  # Test community connector tool
  test-community-connector:
    needs: changes
    if: ${{ needs.changes.outputs.community_connector == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          cd tools/community_connector
          pip install -e ".[dev]"
      - name: Run community connector tests
        run: |
          cd tools/community_connector
          pytest tests/ -v
